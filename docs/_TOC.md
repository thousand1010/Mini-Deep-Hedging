# プロジェクトの解説

このドキュメントでは、プロジェクトを構成する主要なファイルと、それぞれの役割について説明します。

---

## 1. データ関連ユーティリティ (`src/data.py`)

価格生成とブラック-ショールズモデル（オプション価格とデルタ）を提供するファイルです。

### 役割
幾何ブラウン運動（GBM）を用いて株価経路をモンテカルロ・シミュレーションで生成します。また、ブラック-ショールズモデルのコールオプション価格とデルタ（解析解）を計算します。

### 主要な関数
* `gbm_simulate(..., device)`:
    * **機能**: 時刻 `0` から `n_steps` までのスポット価格経路を生成します。
    * **特徴**: 対数価格の累積和で一括生成し、`torch.randn`を使用することでGPUでの生成も可能です。
* `bs_call_price(S, K, r, sigma, tau)`と `bs_delta(S, K, r, sigma, tau)`:
    * **機能**: ブラック-ショールズモデルに基づき、コールオプション価格とデルタを計算します。
    * **特徴**: 現在はNumPyとSciPy（`scipy.stats.norm.cdf`）で計算し、結果をNumPy配列で返します。

---

## 2. 方策ネットワーク (PolicyNet) (`src/model.py`)

時刻 *t* における観測値から、保有すべき原資産の数量を出力する多層パーセプトロン（MLP）です。

### 役割
各時刻 *t* での観測値を受け取り、その時点で保有すべき原資産の数量 `φ_t` を出力します。

### アーキテクチャ
* **目的**: 終端時点の損益分布の分散を最小化すること、つまりリスクの最小化を目的とします。
* **構成**: 隠れ層2つ（128, 128）、`ReLU`活性化関数、線形出力層からなるシンプルなMLPです。
* **入出力**:
    * **入力**: `[S_t, 残存期間, 前時点のポジション]`
    * **出力**: `[この時刻に保有すべき原資産の数量]`
* **`forward`メソッド**: `(batch, obs_dim)`から`(batch,)`を返します。出力が直接ポジションとなるため、損失からの勾配が直接伝播します。

---

## 3. 学習ループ (`src/train.py`)

学習プロセス全体を管理するファイルです。

### 役割
ミニバッチ単位でGBM経路を生成し、各時刻でネットワークによってポジションを決定します。その後、取引コストやキャッシュフローを計算し、最終的な損益の二乗平均を損失として最小化します。

### 学習フロー
1.  デバイス設定
2.  モデルとAdamオプティマイザの初期化
3.  学習ループ:
    * `iters_per_epoch`回、ミニバッチを生成して学習を行います。
    * `S = gbm_simulate(...)`で株価経路を一括生成します。
    * `positions`, `trade_costs`, `cash`, `prev_pos`をゼロに初期化します。
    * **各時刻 `t` の処理**:
        * 観測値 `obs = [S[:,t], time_to_maturity, prev_pos]` を作成。
        * モデルからポジション `pos = model(obs)` を取得し、取引量の変化 `delta_pos = pos - prev_pos` を計算。
        * 取引コスト `cost = k * |delta_pos| * S[:,t]` を加算。
        * 現金フロー `cash -= delta_pos * S[:,t]` を更新。
        * `prev_pos = pos` を更新。
    * **最終精算**: `cash += prev_pos * S[:,-1]`
    * **オプションのペイオフ**: ショートポジションを想定し、`payoff = max(S_T - K, 0)` を計算。
    * **最終損益 (P&L)**: `terminal_pl = cash - payoff - trade_costs`
    * **損失計算**: `loss = mean(terminal_pl**2)` を逆伝播し、パラメータを更新します。

---

## 4. バックテストとデルタヘッジ比較 (`src/eval.py`)

学習済みモデルの性能を評価し、ブラック-ショールズ・デルタヘッジ戦略と比較するファイルです。

### 役割
学習済みモデルと解析デルタヘッジを同じ株価経路で評価し、終端時点の損益分布や統計量を比較します。結果はグラフと統計情報として保存されます。

### 評価フロー
1.  `gbm_simulate`を用いて評価用の株価経路を生成します（`n_paths`）。
2.  各時刻で学習済みモデルと解析デルタの両方のポジションを計算し、`cash`と`trade_costs`をそれぞれ集計します。
3.  最終精算を行い、モデルとデルタヘッジの終端P&L (`terminal_pl_model`, `terminal_pl_delta`) を算出します。
4.  KDE (`seaborn`) またはヒストグラムを用いて損益分布を可視化します。
5.  平均、標準偏差、中央値などの統計量を表示し、グラフと統計ファイルを `results/figures` ディレクトリに保存します。